<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>

	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="author" content="SemiColonWeb" />

	<!-- Stylesheets
	============================================= -->
	<link href="http://fonts.googleapis.com/css?family=Playfair+Display:400,400italic,700italic|Poppins:300,400,500,600,700" rel="stylesheet" type="text/css" />
	<link rel="stylesheet" href="css/bootstrap.css" type="text/css" />
	<link rel="stylesheet" href="css/
	style.css" type="text/css" />
	<link rel="stylesheet" href="css/dark.css" type="text/css" />
	<link rel="stylesheet" href="css/font-icons.css" type="text/css" />
	<link rel="stylesheet" href="one-page/css/et-line.css" type="text/css" />
	<link rel="stylesheet" href="css/animate.css" type="text/css" />
	<link rel="stylesheet" href="css/magnific-popup.css" type="text/css" />

	<link rel="stylesheet" href="css/responsive.css" type="text/css" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />

	<link rel="stylesheet" href="css/intro-fonts.css" type="text/css" />
	<link rel="stylesheet" href="css/colors.php?color=3EA98D" type="text/css" />

	<!-- Document Title
	============================================= -->
	<title>매칭 페이지</title>

<style>

	.white-section {
	background-color: #FFF;
	padding: 25px 20px;
	-webkit-box-shadow: 0px 1px 1px 0px #dfdfdf;
	box-shadow: 0px 1px 1px 0px #dfdfdf;
	border-radius: 3px;
	}

	.white-section2 {
	background-color: #FFF;
	-webkit-box-shadow: 0px 1px 1px 0px #dfdfdf;
	box-shadow: 0px 1px 1px 0px #dfdfdf;
	border-radius: 3px;
	}
</style>

</head>

<body class="stretched">

	<!-- Document Wrapper
	============================================= -->
	<div id="wrapper" class="clearfix">

		<!-- Header
		============================================= -->
	


		<!-- 매칭 돌리는 버튼
		============================================= -->
		<section id="content_1">

			<div class="section nomargin">

				<div class="container clearfix">
				<div class='col_full'>
				<img src ='/img/rlogo.png' width='140'>
				</div>
					<div>
						<div class="col_full white-section" style='padding : 120px;'>
							<center>
							<div class="fslider">
								<div class="flexslider">
									<h3>Match Queue</h3>
									<a id="queue_start" href="#" class="button button-3d topmargin pulse animated infinite"  data-delay="4000" data-animate="pulse">상대팀 찾기</a>
								</div>
							</div>
				
							<div class = 'topmargin'>
								<a href='#myModal' data-lightbox="inline" style='color : grey; opacity : 0.4; font-size :14px;'>도움이 필요하세요?</a>
							</div>		
							</center>
						</div>
					</div>
				</div>
			</div>

		</section>


								<div class="modal1 mfp-hide" id="myModal">
									<div class="block divcenter" style="background-color: #FFF; max-width: 500px;">
										<div style="padding: 50px;">
											<h3>도움말</h3>
											<p class="nobottommargin">Match Queue는 하루에 한 번 돌릴 수 있어요. 매일밤 자정에 Queue가 갱신됩니다. Queue를 돌리면 2개의 팀이 결과로 나와요. 그 중 한 팀을 선택하세요. 상대도 ok하면 서로의 연락처를 알 수 있습니다.</p>
										</div>
										<div class="section center nomargin" style="padding: 30px;">
											<a href="#" class="button" onClick="$.magnificPopup.close();return false;">닫기</a>
										</div>
									</div>
								</div>

		<!-- 매칭결과 페이지
		============================================= -->
<section  id="match_box">

			<div class="section nomargin">

				<div class="container clearfix">
				<div class='col_half'>
				<img src ='/img/rlogo.png' width='140'>
				</div>

					<div class="container clearfix nopadding">		
						

						<div class="col_half white-section2">
							<div class="feature-box center media-box fbox-bg">
								<div class="fbox-media" id='match1_select'>
								</div>
								<div class="fbox-desc" id='match1'>
								</div>
							</div>
						</div>
						<div class='visible-xs bottommargin' style='text-align :center;'>VS</div>
						<div class="col_half norightmargin white-section2">
							<div class="feature-box center media-box fbox-bg">
								<div class="fbox-media" id='match2_select'>			
								</div>
								<div class="fbox-desc" id='match2'>
								</div>
							</div>
						</div>

						<div class = "col_full">
						<div class="style-msg" style="background-color: #EEE;">
							<div class="sb-msg"><i class="icon-info-sign"></i>한 팀을 선택해주세요. 해당 큐는 <strong>매일밤 자정에 만료</strong>됩니다. 자정이 되기전에 선택을 완료해주세요,</div>
						</div>
						</div>					
					</div>
				</div>	
							
			</div>

		</section>
		<!-- Footer
		============================================= -->
		<footer id="footer" class="dark">

			<!-- Copyrights
			============================================= -->
			<div id="copyrights">

				<div class="container clearfix">

					<div class="col_half">
						<img src="/img/rlogo-white.png" alt="Footer Logo" class="footer-logo" width="100" style="opacity :0.25">
						
						Copyrights &copy; 2017 All Rights Reserved by RedMirror Inc.
					</div>

					<div class="col_half col_last tright">
						<div class="copyrights-menu copyright-links fright clearfix">
							<a href="#">Home</a>/<a href="#">About</a>/<a href="#">Features</a>/<a href="#">Portfolio</a>/<a href="#">FAQs</a>/<a href="#">Contact</a>
						</div>
						<div class="fright clearfix">
							<a href="#" class="social-icon si-small si-borderless nobottommargin si-facebook">
								<i class="icon-facebook"></i>
								<i class="icon-facebook"></i>
							</a>

						</div>
					</div>

				</div>

			</div><!-- #copyrights end -->

		</footer><!-- #footer end -->


	</div><!-- #wrapper end -->

	<!-- Go To Top
	============================================= -->
	<div id="gotoTop" class="icon-angle-up"></div>

	<script type="text/javascript" src="js/jquery.js"></script>
	<script type="text/javascript" src="js/plugins.js"></script>
	<script type="text/javascript" src="js/functions.js"></script>
	<script src="js/login.js"></script>
	<script>
	var user_id = getCookie("user_id");
	var userNum = getCookie("user_num");
	var requestNum
	// var user_id = "test"
	// var userNum = 16

	$(document).ready(function(){
		if(user_id == "" || userNum ==""){
            location.href = 'login.html';
        }
		$(document).on("click", "#queue_start", StartQueue)
		default_show()

	})

	function default_show(){
		$("#match_box").show()
		$.ajax({
			url		: 'http://13.124.15.208:9000/queue/',
			//url  :'http://ec2-13-124-98-159.ap-northeast-2.compute.amazonaws.com:9000/queue/',
			dataType: "json",
			type: "GET",
			cache: true,
			jsonp: true,
			jsonpCallback: "",
			data : {
				userNum 	: userNum
			},
			success: function(data){
				console.log(data)

				if(data.type == 1){


					/*대학교 이미지 삽입 */
					if(data.content.m1_user_univ == '서강대학교'){
						var img_src = "<img src='/img/campus/sogang.jpg'>"
					}
					else if (data.content.m1_user_univ == '연세대학교') {
						var img_src = "<img src='/img/campus/yonsei.jpg'>"
					}
					else if (data.content.m1_user_univ == '이화여자대학교') {
						var img_src = "<img src='/img/campus/ewha.jpg'>"
					}
					else if (data.content.m1_user_univ == '홍익대학교') {
						var img_src = "<img src='/img/campus/hongik.jpg'>"
					}

					if(data.content.m2_user_univ == '서강대학교'){
						var img_src2 = "<img src='/img/campus/sogang.jpg'>"
					}
					else if (data.content.m2_user_univ == '연세대학교') {
						var img_src2 = "<img src='/img/campus/yonsei.jpg'>"
					}
					else if (data.content.m2_user_univ == '이화여자대학교') {
						var img_src2 = "<img src='/img/campus/ewha.jpg'>"
					}
					else if (data.content.m2_user_univ == '홍익대학교') {
						var img_src2 = "<img src='/img/campus/hongik.jpg'>"
					}

					/* 이미지 변수 끝 */

					requestNum = data.request_num
					var match1_select = "<a href='#' onclick='MatchRequest("+data.content.m1_user_num+","+ data.request_num+")'>"+img_src+"</a>";
					var match1 = '<h3>'
						match1+= data.content.m1_user_univ;
						match1+= '<span class="subtitle">평균 ';
						match1+= data.content.m1_user_age +'세, ' + data.content.m1_user_count + '명'
						match1+= '</span>'
						match1+= '<span class="subtitle" style="opacity:0.7"><code>'
						match1+= data.content.m1_user_concern
						match1+= '</code></span>'
						match1+= '</h3>'
						match1+= '<br>'
						match1+= "<a href='#' class='button button-border button-rounded button-red' onclick='MatchRequest("+data.content.m1_user_num+","+ data.request_num+")'><i class='icon-off'></i>선택</a>";

					var match2_select = "<a href='#' onclick='MatchRequest("+data.content.m2_user_num+","+ data.request_num+")'>"+img_src2+"</a>";
					var match2 = '<h3>'
						match2+= data.content.m2_user_univ;
						match2+= '<span class="subtitle">평균 ';
						match2+= data.content.m2_user_age +'세, ' + data.content.m2_user_count + '명'
						match2+= '</span>'
						match2+= '<span class="subtitle" style="opacity:0.7"><code>'
						match2+= data.content.m2_user_concern
						match2+= '</code></span>'
						match2+= '</h3>'
						match2+= '<br>'
						match2+= "<a href='#' class='button button-border button-rounded button-red' onclick='MatchRequest("+data.content.m2_user_num+","+ data.request_num+")'><i class='icon-off'></i>선택</a>";

						// $(document).on('dblclick', '#an_tnam tr', function(event) {
    					// 	ADS('hello');
						// });
					// $("#match1-select").click(function(){
					// 	alert("hihi1");
					// 	// MatchRequest(data.content.m1_user_num, data.request_num);
					// });
					// $("#match2-select").click(function(){
					// 	alert("hihi2");
					// 	// MatchRequest(data.content.m2_user_num, data.request_num);
					// });

						// $("#match1_select").click({param1: "hello", param2: "hello"}, MatchRequest);
						// $("#match2_select").click({param1: "hello", param2: "hello"}, MatchRequest);
					$("#match1_select").html(match1_select)
					$("#match2_select").html(match2_select)
					$("#match1").html(match1)
					$("#match2").html(match2)
					$("#queue_start").hide()
					$("#content_1").hide()	


				}
				else{
					$("#match_box").hide()
				}

			},
			error: function() {
				alert("잠시 후 다시 시도해주세요.");
			}
		});
	}

	function StartQueue(){

		if( confirm("매칭을 진행하시겠습니까?") == true){
			$.ajax({
				url : 'http://13.124.15.208:9000/match',
				//url  :'http://ec2-13-124-98-159.ap-northeast-2.compute.amazonaws.com:9000/match',
				dataType: "json",
				type: "GET",
				cache: true,
				jsonp: true,
				jsonpCallback: "",
				data : {
					userNum 	: userNum
				},
				success: function(data){
					console.log(data)
					if(data.type == 1){
						match1_user_num = data.match1.user_num;
						match2_user_num = data.match2.user_num;

						$.ajax({
							url : 'http://13.124.15.208:9000/queue',
							//url  :'http://ec2-13-124-98-159.ap-northeast-2.compute.amazonaws.com:9000/queue',
							dataType: "json",
							type: "POST",
							cache: true,
							jsonp: true,
							jsonpCallback: "",
							data : {
								userNum 	: userNum,
								matchNum1 	: match1_user_num,
								matchNum2 	: match2_user_num
							},
							success: function(data){
								alert("큐가 등록되었습니다.");
								default_show();
							},
							error: function() {
								alert("잠시 후 다시 시도해주세요.");
							}
						});
					}
					else if(data.type == 2){
						alert("오늘은 이미 큐를 돌렸어요. 자정이 지나면 다시 돌릴 수 있어요.")
					}
					else{
						alert("정상적으로 실행이 되지 않습니다.[1]");
					}

				},
				error: function() {
					alert("잠시 후 다시 시도해주세요.");
				}
			});
		}
	}
	function MatchRequest(toUserNum, queueNum){
		if( confirm("해당 팀을 선택하시겠습니까?") == true ){

			$.ajax({
				url : 'http://13.124.15.208:9000/match',
				//url  :'http://ec2-13-124-98-159.ap-northeast-2.compute.amazonaws.com:9000/match',
				dataType: "json",
				type: "POST",
				cache: true,
				jsonp: true,
				jsonpCallback: "",
				data : {
					fromUserNum : userNum,
					toUserNum 	: toUserNum,
					requestNum 	: requestNum
				},
				success: function(data){
					if(data.type == 1){

						$.ajax({
							url	 : 'http://13.124.15.208:9000/queue',
							//url  :'http://ec2-13-124-98-159.ap-northeast-2.compute.amazonaws.com:9000/queue',
							dataType: "json",
							type: "PUT",
							cache: true,
							jsonp: true,
							jsonpCallback: "",
							data : {
								queueNum 	: queueNum
							},
							success: function(data){
								if(data.type == 1){
									alert("미팅신청을 보냈습니다. 상대팀이 수락하면 연락처를 열람할 수 있습니다.")
									location.href = 'list.html';
								}
							},
							error: function() {
								alert("잠시 후 다시 시도해주세요2.");
							}
						});
						// alert("미팅신청을 보냈습니다3.")
						// location.href = '0-main.html';
					}
				},
				error: function() {
					alert("잠시 후 다시 시도해주세요4.");
				}
			});
		}
	}


	</script>


</body>
</html>